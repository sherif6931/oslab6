# This file was auto-generated.

name: Test Requirements

on:
  push:
    branches: [ main, dev ]
  pull_request:
    branches: [ main, dev ]

jobs:
  run-binary:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Check output
      shell: pwsh
      run : |
      
        $errors = @()

        foreach ($input in @( "1", "0" )) {
          $in = "in$input.txt"
          $out = "out$input.txt"
          Set-Content $in $input
          $p = Start-Process -FilePath ".\bin\out.exe" -RedirectStandardInput $in -RedirectStandardOutput $out -NoNewWindow -PassThru

          if (-not $p.WaitForExit(15000)) { 
            $errors += "❎ Program timeout (input=$input)"
          }

          $output = Get-Content $out -Raw

          if ($output -notmatch "Child1 PID:.*Parent PID:") { 
            $errors += "❎ Child1 PID/Parent Requirement Failed (input=$input)"
          }

          if ($output -notmatch "Child2 PID:.*Parent PID:") { 
            $errors += "❎ Child2 PID/Parent Requirement Failed (input=$input)"
          }

          if ($input -eq "1" -and $output -match "child process is resumed") { 
            $errors += "❎ Child2 should have been killed (input=$input)"
          }

          if ($input -eq "0" -and $output -notmatch "child process is resumed") { 
            $errors += "❎ Child2 should have been resumed (input=$input)"
          }

          if (-not $p.HasExited) { 
            $errors += "❎ Program did not terminate properly (input=$input)"
          }
        }

        if ($errors.Count -gt 0) {
          $errors | ForEach-Object { Write-Host $_ }
          Write-Error "❌ One or more requirements failed."
        }
